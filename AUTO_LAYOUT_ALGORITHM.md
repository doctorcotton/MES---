# è‡ªåŠ¨å¸ƒå±€ç®—æ³•è¯¦ç»†æ–‡æ¡£

## ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å®ç°çŠ¶æ€æ€»è§ˆ](#å®ç°çŠ¶æ€æ€»è§ˆ)
3. [æŠ€æœ¯è·¯çº¿](#æŠ€æœ¯è·¯çº¿)
4. [ç®—æ³•æ¶æ„](#ç®—æ³•æ¶æ„)
5. [æ ¸å¿ƒç®—æ³•è¯¦è§£](#æ ¸å¿ƒç®—æ³•è¯¦è§£)
6. [èŠ‚ç‚¹å°ºå¯¸è®¡ç®—](#èŠ‚ç‚¹å°ºå¯¸è®¡ç®—)
7. [ç²¾ç¡®é«˜åº¦è®¡ç®—](#ç²¾ç¡®é«˜åº¦è®¡ç®—)
8. [è°ƒè¯•æ¨¡å¼](#è°ƒè¯•æ¨¡å¼)
9. [æ•°æ®å­˜å‚¨æ ¼å¼](#æ•°æ®å­˜å‚¨æ ¼å¼)
10. [ä»£ç å®ç°ç»†èŠ‚](#ä»£ç å®ç°ç»†èŠ‚)
11. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
12. [å®ç°çŠ¶æ€è¯´æ˜](#å®ç°çŠ¶æ€è¯´æ˜)

---

## æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†ä¸€ä¸ªæ™ºèƒ½çš„å·¥è‰ºæµç¨‹å›¾è‡ªåŠ¨å¸ƒå±€ç®—æ³•ï¼Œç”¨äºè‡ªåŠ¨è®¡ç®—å’Œæ’åˆ—é…æ–¹å·¥è‰ºæµç¨‹å›¾ä¸­çš„èŠ‚ç‚¹ä½ç½®ã€‚ç®—æ³•é‡‡ç”¨**å·¥è‰ºæ®µè¯†åˆ« + åˆ†æ®µå¸ƒå±€**çš„ç­–ç•¥ï¼Œèƒ½å¤Ÿå¤„ç†å¤æ‚çš„å¹¶è¡Œ-ä¸²è¡Œæ··åˆæµç¨‹ï¼Œç¡®ä¿è¿çº¿é•¿åº¦å‡åŒ€ã€è§†è§‰ç¾è§‚ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å·¥è‰ºæ®µè‡ªåŠ¨è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶è¡Œå·¥è‰ºæ®µå’Œä¸²è¡Œå·¥è‰ºæ®µ
- âœ… **åˆ†æ®µå¸ƒå±€è®¡ç®—**ï¼šå¹¶è¡Œæ®µå’Œä¸²è¡Œæ®µé‡‡ç”¨ä¸åŒçš„å¸ƒå±€ç­–ç•¥
- âœ… **å›ºå®šè¿çº¿é•¿åº¦**ï¼šç¡®ä¿æ‰€æœ‰è¿çº¿é•¿åº¦ç»Ÿä¸€ï¼ˆç›®æ ‡å€¼ï¼š120pxï¼‰
- âš ï¸ **èŠ‚ç‚¹å°ºå¯¸è®¡ç®—**ï¼šä½¿ç”¨ React Flow è‡ªåŠ¨æµ‹é‡çš„çœŸå®å°ºå¯¸ï¼ˆé Canvas APIï¼‰
- âœ… **åˆ†æ¡£å®½åº¦ç­–ç•¥**ï¼šæ ¹æ®è¾“å…¥æ•°é‡åŠ¨æ€è®¡ç®—èŠ‚ç‚¹å®½åº¦ï¼ˆåœ¨ CustomNode ä¸­å®ç°ï¼‰
- âœ… **æ°´å¹³å¯¹é½ä¼˜åŒ–**ï¼šåŸºäº `displayOrder` çš„æ°´å¹³å¯¹é½
- âœ… **æ±‡èšç‚¹æ™ºèƒ½å±…ä¸­**ï¼šå¤šè¾“å…¥èŠ‚ç‚¹çš„åŠ æƒå±…ä¸­ç®—æ³•
- âœ… **è°ƒè¯•æ¨¡å¼**ï¼šå¯è§†åŒ–æ˜¾ç¤ºè¿çº¿é•¿åº¦å’Œè¯¯å·®ï¼Œå¿«é€Ÿå®šä½å¸ƒå±€é—®é¢˜

---

## å®ç°çŠ¶æ€æ€»è§ˆ

| åŠŸèƒ½æ¨¡å— | å®ç°çŠ¶æ€ | è¯´æ˜ |
|---------|---------|------|
| **å·¥è‰ºæ®µè¯†åˆ«** | âœ… å·²å®ç° | `segmentIdentifier.ts` - ä½¿ç”¨ DFS ç®—æ³•è¯†åˆ«å¹¶è¡Œ/ä¸²è¡Œæ®µ |
| **å¹¶è¡Œæ®µå¸ƒå±€** | âœ… å·²å®ç° | `layoutParallelSegments` - å›ºå®šè¿çº¿é•¿åº¦ 120px |
| **ä¸²è¡Œæ®µå¸ƒå±€** | âœ… å·²å®ç° | `layoutSerialSegments` - ä»æ±‡èšç‚¹å‘ä¸‹æ’åˆ— |
| **æ±‡èšç‚¹Yåæ ‡è®¡ç®—** | âœ… å·²å®ç° | `calculateConvergenceY` - æ”¯æŒ max/weighted/median ç­–ç•¥ |
| **æ±‡èšç‚¹Xåæ ‡å±…ä¸­** | âœ… å·²å®ç° | åŠ æƒè´¨å¿ƒç®—æ³•ï¼ŒåŸºäºå­æ ‘è§„æ¨¡ |
| **åŸºäº displayOrder çš„æ°´å¹³å¸ƒå±€** | âœ… å·²å®ç° | æ¯ä¸ª Process åˆ†é…ä¸€ä¸ªæ°´å¹³è½¦é“ |
| **åˆ†æ¡£å®½åº¦è®¡ç®—** | âœ… å·²å®ç° | `CustomNode.tsx` ä¸­çš„ `getTieredWidth` å‡½æ•° |
| **èŠ‚ç‚¹å°ºå¯¸è·å–** | âœ… å·²å®ç° | ä½¿ç”¨ React Flow è‡ªåŠ¨æµ‹é‡çš„ `node.width` å’Œ `node.height` |
| **è°ƒè¯•æ¨¡å¼** | âœ… å·²å®ç° | `DebugOverlay.tsx` å’Œ `DebugStatsPanel.tsx` |
| **Canvas API æ–‡å­—æµ‹é‡** | âŒ æœªå®ç° | æ–‡æ¡£ä¸­æè¿°ä½†ä»£ç ä¸­ä¸å­˜åœ¨ |
| **æ™ºèƒ½ç»Ÿä¸€å°ºå¯¸** | âŒ æœªå®ç° | æ–‡æ¡£ä¸­æè¿°ä½†ä»£ç ä¸­ä¸å­˜åœ¨ |
| **åˆ†æ”¯é‡æ’åº** | âŒ æœªå®ç° | æ–‡æ¡£ä¸­æè¿°ä½†ä»£ç ä¸­ä¸å­˜åœ¨ |
| **å¹¶è¡Œåˆ†æ”¯å‹ç¼©** | âŒ æœªå®ç° | æ–‡æ¡£ä¸­æè¿°ä½†ä»£ç ä¸­ä¸å­˜åœ¨ |

---

## æŠ€æœ¯è·¯çº¿

### æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **React Flow** | 11.11.0 | æµç¨‹å›¾æ¸²æŸ“å¼•æ“ï¼ˆæä¾›èŠ‚ç‚¹å°ºå¯¸è‡ªåŠ¨æµ‹é‡ï¼‰ |
| **TypeScript** | 5.2.2 | ç±»å‹å®‰å…¨ |
| **Zustand** | 4.5.0 | çŠ¶æ€ç®¡ç† |
| **React Hooks** | - | å“åº”å¼å¸ƒå±€è®¡ç®—ï¼ˆuseLayoutEffect, useNodesInitializedï¼‰ |

**æ³¨æ„**ï¼šæ–‡æ¡£ä¸­æåˆ°çš„ Dagre åº“æœªåœ¨ä»£ç ä¸­ä½¿ç”¨ã€‚æ°´å¹³å¸ƒå±€ç›´æ¥åŸºäº `displayOrder` è®¡ç®—ï¼Œä¸ä¾èµ–å›¾å½¢å¸ƒå±€ç®—æ³•åº“ã€‚

### ç®—æ³•æµç¨‹

```mermaid
flowchart TD
    A[å¼€å§‹å¸ƒå±€è®¡ç®—] --> B[ç­‰å¾…èŠ‚ç‚¹åˆå§‹åŒ–]
    B --> C{èŠ‚ç‚¹å°ºå¯¸å·²æµ‹é‡?}
    C -->|å¦| B
    C -->|æ˜¯| D[æ”¶é›†èŠ‚ç‚¹çœŸå®å°ºå¯¸]
    D --> E[è¯†åˆ«å·¥è‰ºæ®µ]
    E --> F[åŸºäºdisplayOrderåˆ†é…Xåæ ‡]
    F --> G[å¸ƒå±€å¹¶è¡Œæ®µYåæ ‡]
    G --> H[è®¡ç®—æ±‡èšç‚¹Yåæ ‡]
    H --> I[è®¡ç®—æ±‡èšç‚¹Xåæ ‡åŠ æƒå±…ä¸­]
    I --> J[å¸ƒå±€ä¸²è¡Œæ®µYåæ ‡]
    J --> K[åº”ç”¨Xåæ ‡åˆ°ä¸²è¡Œæ®µ]
    K --> L[è½¬æ¢ä¸ºå·¦ä¸Šè§’åæ ‡]
    L --> M[æ›´æ–°èŠ‚ç‚¹ä½ç½®]
    M --> N[è°ƒç”¨fitView]
    N --> O[ç»“æŸ]
```

---

## ç®—æ³•æ¶æ„

### æ¨¡å—åˆ’åˆ†

```
src/components/graph/
â”œâ”€â”€ LayoutController.tsx      # ä¸»å¸ƒå±€æ§åˆ¶å™¨ï¼ˆå…¥å£ï¼ŒHeadless Componentï¼‰
â”œâ”€â”€ RecipeFlow.tsx            # React Flow ç»„ä»¶ï¼ˆé›†æˆå¸ƒå±€æ§åˆ¶å™¨ï¼‰
â”œâ”€â”€ DebugOverlay.tsx          # è°ƒè¯•å åŠ å±‚ç»„ä»¶
â””â”€â”€ DebugStatsPanel.tsx       # è°ƒè¯•ç»Ÿè®¡é¢æ¿

src/hooks/
â”œâ”€â”€ segmentIdentifier.ts      # å·¥è‰ºæ®µè¯†åˆ«ç®—æ³•
â””â”€â”€ segmentLayoutCalculator.ts # åˆ†æ®µå¸ƒå±€è®¡ç®—å™¨

src/components/graph/
â””â”€â”€ CustomNode.tsx            # è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶ï¼ˆåŒ…å«åˆ†æ¡£å®½åº¦è®¡ç®—ï¼‰
```

### æ•°æ®æµ

```mermaid
sequenceDiagram
    participant RecipeFlow as RecipeFlow
    participant LayoutCtrl as LayoutController
    participant ReactFlow as React Flow
    participant Identifier as segmentIdentifier
    participant Calculator as segmentLayoutCalculator

    RecipeFlow->>LayoutCtrl: å†…å®¹å˜åŒ–è§¦å‘å¸ƒå±€
    LayoutCtrl->>ReactFlow: ç­‰å¾…èŠ‚ç‚¹åˆå§‹åŒ–ï¼ˆuseNodesInitializedï¼‰
    ReactFlow-->>LayoutCtrl: èŠ‚ç‚¹å°ºå¯¸å·²æµ‹é‡ï¼ˆnode.width, node.heightï¼‰
    LayoutCtrl->>Identifier: è¯†åˆ«å·¥è‰ºæ®µ
    Identifier-->>LayoutCtrl: å¹¶è¡Œæ®µ + ä¸²è¡Œæ®µ
    LayoutCtrl->>Calculator: å¸ƒå±€å¹¶è¡Œæ®µ
    Calculator-->>LayoutCtrl: å¹¶è¡Œæ®µYåæ ‡
    LayoutCtrl->>Calculator: è®¡ç®—æ±‡èšç‚¹Y
    Calculator-->>LayoutCtrl: æ±‡èšç‚¹Yåæ ‡
    LayoutCtrl->>LayoutCtrl: åŸºäº displayOrder åˆ†é…Xåæ ‡
    LayoutCtrl->>LayoutCtrl: è®¡ç®—æ±‡èšç‚¹Xåæ ‡ï¼ˆåŠ æƒå±…ä¸­ï¼‰
    LayoutCtrl->>Calculator: å¸ƒå±€ä¸²è¡Œæ®µ
    Calculator-->>LayoutCtrl: ä¸²è¡Œæ®µYåæ ‡
    LayoutCtrl->>LayoutCtrl: è½¬æ¢ä¸ºå·¦ä¸Šè§’åæ ‡
    LayoutCtrl->>ReactFlow: æ›´æ–°èŠ‚ç‚¹ä½ç½®ï¼ˆsetNodesï¼‰
    LayoutCtrl->>ReactFlow: è°ƒç”¨ fitView
    LayoutCtrl->>RecipeFlow: é€šçŸ¥å¸ƒå±€å®Œæˆ
```

### å…³é”®è®¾è®¡å†³ç­–

1. **Headless Component æ¨¡å¼**ï¼š`LayoutController` ä¸æ¸²æŸ“ä»»ä½• UIï¼Œä»…è´Ÿè´£å¸ƒå±€è®¡ç®—
2. **ç­‰å¾…èŠ‚ç‚¹å°ºå¯¸æµ‹é‡**ï¼šä½¿ç”¨ React Flow çš„ `useNodesInitialized` ç¡®ä¿èŠ‚ç‚¹å°ºå¯¸å·²æµ‹é‡
3. **åæ ‡ç³»ç»Ÿ**ï¼šå†…éƒ¨ä½¿ç”¨ä¸­å¿ƒç‚¹åæ ‡è®¡ç®—ï¼Œæœ€åè½¬æ¢ä¸ºå·¦ä¸Šè§’åæ ‡ï¼ˆReact Flow è¦æ±‚ï¼‰
4. **å¸ƒå±€è§¦å‘**ï¼šåŸºäºå†…å®¹å˜åŒ–è§¦å‘å™¨ï¼ˆ`layoutTrigger`ï¼‰ï¼ŒåŒ…å«å·¥è‰ºæ®µIDã€å­æ­¥éª¤IDã€å±•å¼€çŠ¶æ€

---

## æ ¸å¿ƒç®—æ³•è¯¦è§£

### 1. å·¥è‰ºæ®µè¯†åˆ«ç®—æ³• (`segmentIdentifier.ts`)

#### ç®—æ³•åŸç†

å·¥è‰ºæ®µè¯†åˆ«é‡‡ç”¨**æ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰**ç­–ç•¥ï¼Œä»èµ·ç‚¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œç›´åˆ°é‡åˆ°æ±‡èšç‚¹æˆ–ç»ˆç‚¹ã€‚

#### è¯†åˆ«è§„åˆ™

1. **èµ·ç‚¹èŠ‚ç‚¹**ï¼šå…¥åº¦ä¸º 0 çš„èŠ‚ç‚¹
2. **æ±‡èšç‚¹**ï¼šå…¥åº¦ > 1 çš„èŠ‚ç‚¹ï¼ˆå¤šä¸ªåˆ†æ”¯æ±‡èšï¼‰
3. **å¹¶è¡Œå·¥è‰ºæ®µ**ï¼šä»èµ·ç‚¹åˆ°æ±‡èšç‚¹ä¹‹é—´çš„è·¯å¾„
4. **ä¸²è¡Œå·¥è‰ºæ®µ**ï¼šæ±‡èšç‚¹ä¹‹åçš„è¿ç»­èŠ‚ç‚¹åºåˆ—

#### ä»£ç å®ç°

```typescript
// æ ¸å¿ƒè¯†åˆ«é€»è¾‘
export function identifyProcessSegments(
  nodes: FlowNode[],
  edges: RecipeEdge[]
): SegmentIdentificationResult {
  // 1. æ„å»ºå›¾ç»“æ„ï¼ˆé‚»æ¥è¡¨ï¼‰
  const outgoingEdges = new Map<string, RecipeEdge[]>();
  const incomingEdges = new Map<string, RecipeEdge[]>();
  
  // 2. æ‰¾åˆ°æ‰€æœ‰èµ·ç‚¹èŠ‚ç‚¹ï¼ˆå…¥åº¦ä¸º0ï¼‰
  const startNodes = nodes.filter(node => {
    const incoming = incomingEdges.get(node.id) || [];
    return incoming.length === 0;
  });
  
  // 3. æ‰¾åˆ°æ±‡èšç‚¹ï¼ˆå…¥åº¦ > 1ï¼‰
  const convergenceNodes = nodes.filter(node => {
    const incoming = incomingEdges.get(node.id) || [];
    return incoming.length > 1;
  });
  
  // 4. ä»æ¯ä¸ªèµ·ç‚¹DFSï¼Œæ„å»ºå¹¶è¡Œå·¥è‰ºæ®µ
  const parallelSegments: ProcessSegment[] = [];
  startNodes.forEach((startNode, index) => {
    const segmentNodes: FlowNode[] = [];
    function dfs(currentNodeId: string): void {
      // å¦‚æœé‡åˆ°æ±‡èšç‚¹ï¼Œåœæ­¢éå†
      if (convergenceNode && currentNodeId === convergenceNode.id) {
        return;
      }
      // ç»§ç»­éå†å‡ºè¾¹...
    }
    dfs(startNode.id);
    parallelSegments.push({ ... });
  });
  
  // 5. è¯†åˆ«ä¸²è¡Œå·¥è‰ºæ®µï¼ˆæ±‡èšç‚¹ä¹‹åçš„èŠ‚ç‚¹ï¼‰
  // ...
}
```

#### è¯†åˆ«ç»“æœç»“æ„

```typescript
interface ProcessSegment {
  id: string;              // æ®µIDï¼Œå¦‚ "parallel-segment-0"
  nodes: FlowNode[];       // è¯¥æ®µçš„æ‰€æœ‰èŠ‚ç‚¹
  isParallel: boolean;     // æ˜¯å¦åœ¨å¹¶è¡ŒåŒºåŸŸ
  startNodeId: string;     // èµ·å§‹èŠ‚ç‚¹ID
  endNodeId: string;       // ç»“æŸèŠ‚ç‚¹ID
}
```

---

### 2. åˆ†æ®µå¸ƒå±€è®¡ç®—å™¨ (`segmentLayoutCalculator.ts`)

#### 2.1 å¹¶è¡Œæ®µå¸ƒå±€

**ç›®æ ‡**ï¼šæ‰€æœ‰å¹¶è¡Œæ®µèµ·ç‚¹Yåæ ‡ç›¸åŒï¼Œæ®µå†…è¿çº¿é•¿åº¦å›ºå®šã€‚

```typescript
export function layoutParallelSegments(
  segments: ProcessSegment[],
  nodeHeights: Record<string, number>,
  config: ParallelLayoutConfig
): Record<string, number> {
  const nodeYPositions: Record<string, number> = {};
  
  segments.forEach(segment => {
    let currentY = config.initialY; // æ‰€æœ‰æ®µä»åŒä¸€Yå¼€å§‹
    
    segment.nodes.forEach((node, idx) => {
      nodeYPositions[node.id] = currentY;
      
      if (idx < segment.nodes.length - 1) {
        const nextNode = segment.nodes[idx + 1];
        const currentNodeHeight = nodeHeights[node.id] || 120;
        const nextNodeHeight = nodeHeights[nextNode.id] || 120;
        
        // è®¡ç®—é—´è·ï¼šèŠ‚ç‚¹é«˜åº¦çš„ä¸€åŠ + ç›®æ ‡è¿çº¿é•¿åº¦ + ä¸‹ä¸ªèŠ‚ç‚¹é«˜åº¦çš„ä¸€åŠ
        const spacing =
          currentNodeHeight / 2 +      // å½“å‰èŠ‚ç‚¹åº•éƒ¨åˆ°ä¸­å¿ƒ
          config.targetEdgeLength +    // è¿çº¿é•¿åº¦ï¼ˆå›ºå®š120pxï¼‰
          nextNodeHeight / 2;          // ä¸‹ä¸ªèŠ‚ç‚¹ä¸­å¿ƒåˆ°é¡¶éƒ¨
        
        currentY += spacing;
      }
    });
  });
  
  return nodeYPositions;
}
```

**å¸ƒå±€ç¤ºæ„å›¾**ï¼š

```
å¹¶è¡Œæ®µ1:  [Node1] â”€â”€120pxâ”€â”€ [Node2] â”€â”€120pxâ”€â”€ [Node3]
         â†‘
         èµ·å§‹Y = 80

å¹¶è¡Œæ®µ2:  [Node4] â”€â”€120pxâ”€â”€ [Node5]
         â†‘
         èµ·å§‹Y = 80 (ä¸æ®µ1å¯¹é½)
```

#### 2.2 æ±‡èšç‚¹Yåæ ‡è®¡ç®—

**ç­–ç•¥**ï¼šé‡‡ç”¨ `max` ç­–ç•¥ï¼Œå–æ‰€æœ‰å¹¶è¡Œæ®µç»ˆç‚¹çš„æœ€å¤§Yåæ ‡ã€‚

```typescript
export function calculateConvergenceY(
  parallelSegments: ProcessSegment[],
  nodeYPositions: Record<string, number>,
  nodeHeights: Record<string, number>,
  targetEdgeLength: number,
  strategy: ConvergenceStrategy = 'max'
): number {
  // è®¡ç®—æ¯ä¸ªå¹¶è¡Œæ®µçš„ç»ˆç‚¹Yåæ ‡
  const endYs = parallelSegments.map(seg => {
    const lastNode = seg.nodes[seg.nodes.length - 1];
    const lastNodeY = nodeYPositions[lastNode.id];
    const lastNodeHeight = nodeHeights[lastNode.id] || 120;
    
    // ç»ˆç‚¹Y = èŠ‚ç‚¹ä¸­å¿ƒY + èŠ‚ç‚¹é«˜åº¦çš„ä¸€åŠ + è¿çº¿é•¿åº¦
    return lastNodeY + lastNodeHeight / 2 + targetEdgeLength;
  });
  
  switch (strategy) {
    case 'max':
      return Math.max(...endYs);  // æ¨èï¼šæ‰€æœ‰å…¥è¾¹éƒ½å‘ä¸‹
    case 'weighted':
      // æ ¹æ®å·¥è‰ºæ®µé•¿åº¦åŠ æƒå¹³å‡
      // ...
    case 'median':
      // å–ä¸­ä½æ•°
      // ...
  }
}
```

**å…¶ä»–ç­–ç•¥è¯´æ˜**ï¼š

- **`max`**ï¼ˆæ¨èï¼‰ï¼šæ‰€æœ‰å…¥è¾¹éƒ½å‘ä¸‹ï¼Œç¬¦åˆè§†è§‰ä¹ æƒ¯
- **`weighted`**ï¼šæ ¹æ®å·¥è‰ºæ®µé•¿åº¦åŠ æƒï¼Œé•¿æ®µæƒé‡æ›´å¤§
- **`median`**ï¼šå–æ‰€æœ‰åˆ†æ”¯ç»ˆç‚¹çš„ä¸­ä½æ•°

#### 2.3 ä¸²è¡Œæ®µå¸ƒå±€

**ç›®æ ‡**ï¼šä»æ±‡èšç‚¹å¼€å§‹ï¼Œå‚ç›´å‘ä¸‹æ’åˆ—ï¼Œæ‰€æœ‰è¿çº¿é•¿åº¦ç»Ÿä¸€ã€‚

```typescript
export function layoutSerialSegments(
  segments: ProcessSegment[],
  startY: number,  // æ±‡èšç‚¹ä¹‹åçš„èµ·å§‹Y
  nodeHeights: Record<string, number>,
  config: SerialLayoutConfig
): Record<string, number> {
  const nodeYPositions: Record<string, number> = {};
  let currentY = startY;
  
  segments.forEach(segment => {
    segment.nodes.forEach((node, idx) => {
      nodeYPositions[node.id] = currentY;
      
      if (idx < segment.nodes.length - 1) {
        const nextNode = segment.nodes[idx + 1];
        const spacing =
          nodeHeights[node.id] / 2 +
          config.targetEdgeLength +
          nodeHeights[nextNode.id] / 2;
        
        currentY += spacing;
      }
    });
  });
  
  return nodeYPositions;
}
```

---

## èŠ‚ç‚¹å°ºå¯¸è®¡ç®—

### 1. å®½åº¦è®¡ç®—ï¼ˆåˆ†æ¡£ç­–ç•¥ï¼‰âœ… å·²å®ç°

**å®ç°ä½ç½®**ï¼š`src/components/graph/CustomNode.tsx`

æ ¹æ®è¾“å…¥æ•°é‡åˆ†æ¡£ï¼Œåœ¨èŠ‚ç‚¹æ¸²æŸ“æ—¶åŠ¨æ€è®¡ç®—ï¼š

```typescript
/**
 * æ ¹æ®è¾“å…¥æ•°é‡è®¡ç®—åˆ†æ¡£å®½åº¦
 */
const getTieredWidth = (inputCount: number): number => {
  if (inputCount <= 2) return 200;  // 1-2ä¸ªè¾“å…¥ï¼š200px
  if (inputCount <= 4) return 280;  // 3-4ä¸ªè¾“å…¥ï¼š280px
  return 360;                        // 5ä¸ªåŠä»¥ä¸Šï¼š360px
};
```

**ä½¿ç”¨æ–¹å¼**ï¼šåœ¨ `CustomNode` ç»„ä»¶ä¸­ï¼Œæ ¹æ®èŠ‚ç‚¹çš„è¾“å…¥è¾¹æ•°é‡è®¡ç®—å®½åº¦ï¼š

```typescript
const inputCount = edges.filter(e => e.target === id).length;
const nodeWidth = getTieredWidth(inputCount);

// åº”ç”¨åˆ°èŠ‚ç‚¹æ ·å¼
<div style={{ minWidth: `${nodeWidth}px`, width: `${nodeWidth}px` }}>
  {/* èŠ‚ç‚¹å†…å®¹ */}
</div>
```

### 2. é«˜åº¦è®¡ç®— âš ï¸ å®é™…å®ç°æ–¹å¼

**å®é™…å®ç°**ï¼šä½¿ç”¨ React Flow è‡ªåŠ¨æµ‹é‡çš„çœŸå®å°ºå¯¸ï¼Œè€Œé Canvas APIã€‚

**å®ç°ä½ç½®**ï¼š`src/components/graph/LayoutController.tsx`

```typescript
// React Flow 11 ä¸­èŠ‚ç‚¹å°ºå¯¸å­˜å‚¨åœ¨ node.width å’Œ node.height
// ç­‰å¾… React Flow è‡ªåŠ¨æµ‹é‡èŠ‚ç‚¹å°ºå¯¸
const nodes = getNodes() as FlowNode[];

// æ”¶é›†çœŸå®å°ºå¯¸ï¼ˆReact Flow æµ‹é‡çš„ï¼‰
const nodeHeights: Record<string, number> = {};
const nodeWidths: Record<string, number> = {};
nodes.forEach(node => {
  // æœªæµ‹é‡æ—¶ä½¿ç”¨é»˜è®¤å€¼
  nodeHeights[node.id] = node.height || 120;
  nodeWidths[node.id] = node.width || 200;
});
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä½¿ç”¨å®é™…æ¸²æŸ“å°ºå¯¸ï¼Œæ— éœ€ä¼°ç®—
- âœ… è‡ªåŠ¨é€‚åº”å†…å®¹å˜åŒ–
- âœ… æ”¯æŒåŠ¨æ€å†…å®¹ï¼ˆå±•å¼€/æŠ˜å ï¼‰

**æ³¨æ„**ï¼šæ–‡æ¡£ä¸­æè¿°çš„ Canvas API ç²¾ç¡®æµ‹é‡æ–¹æ³•ï¼ˆ`measureTextHeight`, `wrapText`ï¼‰**æœªåœ¨ä»£ç ä¸­å®ç°**ã€‚å½“å‰å®ç°ä¾èµ– React Flow çš„è‡ªåŠ¨å°ºå¯¸æµ‹é‡ã€‚

### 3. æ™ºèƒ½ç»Ÿä¸€å°ºå¯¸ âŒ æœªå®ç°

**çŠ¶æ€**ï¼šæ–‡æ¡£ä¸­æè¿°ä½†ä»£ç ä¸­ä¸å­˜åœ¨ã€‚

**æè¿°**ï¼šå¯¹ç›¸åŒå·¥è‰ºç±»å‹çš„èŠ‚ç‚¹è¿›è¡Œèšç±»ï¼Œç»Ÿä¸€å°ºå¯¸ã€‚å½“å‰å®ç°ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç‹¬ç«‹è®¡ç®—çš„å°ºå¯¸ã€‚

---

### 4. æ°´å¹³å¸ƒå±€ä¼˜åŒ–

#### 4.1 åŸºäº displayOrder çš„æ°´å¹³å¯¹é½ âœ… å·²å®ç°

**å®ç°ä½ç½®**ï¼š`src/components/graph/LayoutController.tsx`

Xåæ ‡ç›´æ¥ç”± `displayOrder`ï¼ˆè¡¨æ ¼é¡ºåºï¼‰å†³å®šï¼š

```typescript
// æ¯ä¸ª Process åˆ†é…ä¸€ä¸ªæ°´å¹³"è½¦é“"
const PROCESS_LANE_WIDTH = 300; // æ¯ä¸ªå·¥è‰ºæ®µçš„æ°´å¹³è½¦é“å®½åº¦
const LANE_GAP = 64;            // è½¦é“ä¹‹é—´çš„é—´éš™
const START_X = 150;            // èµ·å§‹ X åç§»

// æ ¹æ® displayOrder åˆ†ç»„èŠ‚ç‚¹
const nodesByDisplayOrder: Record<number, FlowNode[]> = {};
nodes.forEach(node => {
  const displayOrder = node.data.displayOrder || 1;
  if (!nodesByDisplayOrder[displayOrder]) {
    nodesByDisplayOrder[displayOrder] = [];
  }
  nodesByDisplayOrder[displayOrder].push(node);
});

// ä¸ºæ¯ä¸ª displayOrder ç»„åˆ†é… X åæ ‡ï¼ˆå­˜å‚¨ä¸ºä¸­å¿ƒç‚¹ï¼‰
const displayOrders = Object.keys(nodesByDisplayOrder).map(Number).sort((a, b) => a - b);
displayOrders.forEach((displayOrder, laneIndex) => {
  const laneX = START_X + laneIndex * (PROCESS_LANE_WIDTH + LANE_GAP);
  nodesByDisplayOrder[displayOrder].forEach(node => {
    const width = nodeWidths[node.id] || 200;
    // å­˜å‚¨èŠ‚ç‚¹ä¸­å¿ƒç‚¹ï¼šè½¦é“å·¦è¾¹ç¼˜ + èŠ‚ç‚¹å®½åº¦çš„ä¸€åŠ
    nodePositions[node.id] = { x: laneX + width / 2, y: 0 };
  });
});
```

#### 4.2 æ±‡èšç‚¹æ°´å¹³å±…ä¸­ âœ… å·²å®ç°

**å®ç°ä½ç½®**ï¼š`src/components/graph/LayoutController.tsx`

é‡‡ç”¨**åŠ æƒè´¨å¿ƒç®—æ³•**ï¼ŒåŸºäºå­æ ‘è§„æ¨¡åŠ æƒï¼š

```typescript
// è®¡ç®—æ±‡èšç‚¹ X åæ ‡ (åŠ æƒè´¨å¿ƒæ³•)
if (parallelSegments.length > 0) {
  let totalWeight = 0;
  let weightedXSum = 0;

  parallelSegments.forEach(segment => {
    // è¿‡æ»¤å‡ºå·²åˆ†é…ä½ç½®çš„èŠ‚ç‚¹
    const validNodes = segment.nodes.filter(n => nodePositions[n.id]);
    if (validNodes.length === 0) return;

    // è®¡ç®—è¯¥åˆ†æ”¯çš„è´¨å¿ƒ X
    const segmentCentroidX = validNodes.reduce((sum, n) => 
      sum + nodePositions[n.id].x, 0
    ) / validNodes.length;

    // æƒé‡ = èŠ‚ç‚¹æ•°é‡ (å­æ ‘è§„æ¨¡)
    const weight = validNodes.length;

    weightedXSum += segmentCentroidX * weight;
    totalWeight += weight;
  });

  if (totalWeight > 0) {
    convergenceX = weightedXSum / totalWeight;
  }
}
```

**ä¸²è¡Œæ®µå¯¹é½**ï¼šä¸²è¡Œæ®µçš„èŠ‚ç‚¹ X åæ ‡ä¸æ±‡èšç‚¹å¯¹é½ï¼š

```typescript
// åº”ç”¨ X åæ ‡åˆ°ä¸²è¡Œæ®µ (ä¸æ±‡èšç‚¹å‚ç›´å¯¹é½)
if (convergenceX > 0) {
  serialSegments.forEach(segment => {
    segment.nodes.forEach(node => {
      if (nodePositions[node.id]) {
        nodePositions[node.id].x = convergenceX;
      }
    });
  });
}
```

#### 4.3 åˆ†æ”¯é‡æ’åº âŒ æœªå®ç°

**çŠ¶æ€**ï¼šæ–‡æ¡£ä¸­æè¿°ä½†ä»£ç ä¸­ä¸å­˜åœ¨ã€‚

**æè¿°**ï¼šæ ¹æ® `sequenceOrder` å’Œ `Process Index` é‡æ’åºåˆ†æ”¯çš„åŠŸèƒ½æœªå®ç°ã€‚

#### 4.4 å¹¶è¡Œåˆ†æ”¯å‹ç¼© âŒ æœªå®ç°

**çŠ¶æ€**ï¼šæ–‡æ¡£ä¸­æè¿°ä½†ä»£ç ä¸­ä¸å­˜åœ¨ã€‚

**æè¿°**ï¼šè¯†åˆ«åŒä¸€å±‚çº§å†…æ— ç›´æ¥è¿æ¥å…³ç³»çš„èŠ‚ç‚¹ï¼Œåº”ç”¨æ›´ç´§å‡‘é—´è·çš„åŠŸèƒ½æœªå®ç°ã€‚

---

### 5. å¸ƒå±€é…ç½®å‚æ•°

```typescript
const LAYOUT_CONFIG = {
  // åŸºç¡€å°ºå¯¸
  baseNodeWidth: 200,
  baseNodeHeight: 120,
  baseRankSep: 180,              // åŸºç¡€å±‚é—´è·
  extraSpacingPerInput: 30,     // æ¯ä¸ªé¢å¤–è¾“å…¥å¢åŠ çš„é—´è·
  minNodeSep: 100,               // æœ€å°èŠ‚ç‚¹é—´è·
  
  // åˆ†æ¡£å®½åº¦é…ç½®
  widthTiers: {
    tier1: { maxInputs: 2, width: 200 },
    tier2: { maxInputs: 4, width: 280 },
    tier3: { maxInputs: Infinity, width: 360 }
  },
  
  // å†…å®¹æ¢è¡Œä¼°ç®—å‚æ•°
  charWidth: 8,                  // æ¯ä¸ªå­—ç¬¦å¹³å‡å®½åº¦ï¼ˆpxï¼‰
  lineHeight: 20,                // æ¯è¡Œæ–‡æœ¬é«˜åº¦ï¼ˆpxï¼‰
  minContentWidth: 150,          // å†…å®¹åŒºåŸŸæœ€å°å®½åº¦
  
  // å·¥è‰ºæ®µå¸ƒå±€å‚æ•°
  targetEdgeLength: 120,        // ç›®æ ‡è¿çº¿é•¿åº¦ï¼ˆå›ºå®šå€¼ï¼‰
  convergenceStrategy: 'max',     // æ±‡èšç‚¹å¤„ç†ç­–ç•¥
  
  // æ°´å¹³å¸ƒå±€å‚æ•°
  PROCESS_LANE_WIDTH: 300,      // æ¯ä¸ªå·¥è‰ºæ®µçš„æ°´å¹³è½¦é“å®½åº¦
  LANE_GAP: 64,                  // è½¦é“ä¹‹é—´çš„é—´éš™
  START_X: 150,                  // èµ·å§‹ X åç§»
  
  // ä¼˜åŒ–é€‰é¡¹
  enableWeightedCentering: true, // æ˜¯å¦å¯ç”¨åŠ æƒå±…ä¸­
  centeringStrategy: 'subtree-size', // å±…ä¸­ç­–ç•¥
};
```

---

## ç²¾ç¡®é«˜åº¦è®¡ç®—

### å®é™…å®ç°æ–¹å¼ âš ï¸

**æ³¨æ„**ï¼šæ–‡æ¡£ä¸­æè¿°çš„ Canvas API ç²¾ç¡®æµ‹é‡æ–¹æ³•**æœªåœ¨ä»£ç ä¸­å®ç°**ã€‚å½“å‰å®ç°ä½¿ç”¨ React Flow çš„è‡ªåŠ¨å°ºå¯¸æµ‹é‡ã€‚

### å½“å‰å®ç°ï¼šReact Flow è‡ªåŠ¨æµ‹é‡

**å®ç°ä½ç½®**ï¼š`src/components/graph/LayoutController.tsx`

ç³»ç»Ÿä½¿ç”¨ React Flow 11 çš„è‡ªåŠ¨å°ºå¯¸æµ‹é‡åŠŸèƒ½ï¼Œåœ¨èŠ‚ç‚¹æ¸²æŸ“åè‡ªåŠ¨è·å–çœŸå®å°ºå¯¸ï¼š

```typescript
// ç­‰å¾… React Flow è‡ªåŠ¨æµ‹é‡æ‰€æœ‰èŠ‚ç‚¹çš„çœŸå®å°ºå¯¸
const nodesInitialized = useNodesInitialized();

useLayoutEffect(() => {
  // æ¡ä»¶1: èŠ‚ç‚¹å·²åˆå§‹åŒ–ï¼ˆReact Flow å·²æµ‹é‡å°ºå¯¸ï¼‰
  if (!nodesInitialized) {
    return;
  }

  const nodes = getNodes() as FlowNode[];
  
  // React Flow 11 ä¸­èŠ‚ç‚¹å°ºå¯¸å­˜å‚¨åœ¨ node.width å’Œ node.height
  const nodeHeights: Record<string, number> = {};
  const nodeWidths: Record<string, number> = {};
  nodes.forEach(node => {
    // æœªæµ‹é‡æ—¶ä½¿ç”¨é»˜è®¤å€¼
    nodeHeights[node.id] = node.height || 120;
    nodeWidths[node.id] = node.width || 200;
  });
  
  // ä½¿ç”¨çœŸå®å°ºå¯¸è¿›è¡Œå¸ƒå±€è®¡ç®—
  // ...
}, [nodesInitialized, getNodes]);
```

### ä¼˜åŠ¿

- âœ… **çœŸå®å°ºå¯¸**ï¼šä½¿ç”¨å®é™…æ¸²æŸ“å°ºå¯¸ï¼Œæ— éœ€ä¼°ç®—
- âœ… **è‡ªåŠ¨é€‚åº”**ï¼šè‡ªåŠ¨é€‚åº”å†…å®¹å˜åŒ–ï¼ˆå±•å¼€/æŠ˜å ã€åŠ¨æ€å†…å®¹ï¼‰
- âœ… **æ— éœ€ç»´æŠ¤**ï¼šä¸éœ€è¦æ‰‹åŠ¨è®¡ç®—æ–‡å­—æ¢è¡Œå’Œé«˜åº¦

### æ–‡æ¡£ä¸­æè¿°çš„ Canvas API æ–¹æ³• âŒ æœªå®ç°

æ–‡æ¡£ä¸­æè¿°çš„ä»¥ä¸‹åŠŸèƒ½**æœªåœ¨ä»£ç ä¸­å®ç°**ï¼š

- `wrapText` å‡½æ•°ï¼šä½¿ç”¨ Canvas API ç²¾ç¡®æµ‹é‡æ–‡å­—æ¢è¡Œ
- `measureTextHeight` å‡½æ•°ï¼šä½¿ç”¨ Canvas API ç²¾ç¡®æµ‹é‡æ–‡æœ¬é«˜åº¦
- åŸºäº Canvas çš„é«˜åº¦ä¼°ç®—é€»è¾‘

**åŸå› **ï¼šReact Flow çš„è‡ªåŠ¨å°ºå¯¸æµ‹é‡å·²ç»æä¾›äº†å‡†ç¡®çš„èŠ‚ç‚¹å°ºå¯¸ï¼Œæ— éœ€æ‰‹åŠ¨è®¡ç®—ã€‚

---

## è°ƒè¯•æ¨¡å¼

### åŠŸèƒ½æ¦‚è¿°

è°ƒè¯•æ¨¡å¼æä¾›å¯è§†åŒ–å·¥å…·ï¼Œå®æ—¶æ˜¾ç¤ºè¿çº¿é•¿åº¦å’Œè¯¯å·®ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½å¸ƒå±€é—®é¢˜ã€‚

### å¯ç”¨æ–¹å¼

**æ–¹æ³•1ï¼šUI å¼€å…³**
- ç‚¹å‡»æµç¨‹å›¾å³ä¸Šè§’çš„è°ƒè¯•æŒ‰é’®
- æŒ‰é’®çŠ¶æ€ï¼šğŸ”´ è°ƒè¯•: å¼€ / âšª è°ƒè¯•: å…³

**æ–¹æ³•2ï¼šæ§åˆ¶å°**
```javascript
localStorage.setItem('debug_layout', 'true');  // å¼€å¯
localStorage.setItem('debug_layout', 'false'); // å…³é—­
```

### æ˜¾ç¤ºå†…å®¹

#### 1. è¿çº¿é•¿åº¦æ ‡æ³¨

æ¯æ¡è¿çº¿æ—è¾¹æ˜¾ç¤ºï¼š
- **å®é™…é•¿åº¦**ï¼šä¾‹å¦‚ `120.3px`
- **è¯¯å·®æ ‡æ³¨**ï¼šè¯¯å·® > 0.5px æ—¶æ˜¾ç¤º `(Î”+0.3)`

#### 2. é¢œè‰²ç¼–ç 

æ ¹æ®è¯¯å·®å¤§å°ä½¿ç”¨ä¸åŒé¢œè‰²ï¼š

| é¢œè‰² | è¯¯å·®èŒƒå›´ | è¯´æ˜ |
|------|---------|------|
| ğŸŸ¢ **ç»¿è‰²** | < 5px | è¯¯å·®å¾ˆå°ï¼Œå¸ƒå±€è‰¯å¥½ |
| ğŸŸ¡ **é»„è‰²** | 5-10px | è¯¯å·®ä¸­ç­‰ï¼Œå¯ä¼˜åŒ– |
| ğŸ”´ **çº¢è‰²** | > 10px | è¯¯å·®è¾ƒå¤§ï¼Œéœ€è¦æ£€æŸ¥ |

#### 3. æ‚¬åœæç¤º

é¼ æ ‡æ‚¬åœåœ¨æ ‡ç­¾ä¸Šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼š
```
ç›®æ ‡: 120px, è¯¯å·®: 0.3px
```

### å®ç°ç»†èŠ‚

**ç»„ä»¶ä½ç½®**ï¼š`src/components/graph/DebugOverlay.tsx`

**æ ¸å¿ƒé€»è¾‘**ï¼š

```typescript
// è®¡ç®—æ¯æ¡è¿çº¿çš„å®é™…é•¿åº¦
const sourceBottom = sourceCenterY + sourceHeight / 2;
const targetTop = targetCenterY - targetHeight / 2;
const actualLength = targetTop - sourceBottom;

// è®¡ç®—è¯¯å·®
const error = Math.abs(actualLength - targetEdgeLength);

// ç¡®å®šé¢œè‰²
let color: 'green' | 'yellow' | 'red' = 'green';
if (error > 10) color = 'red';
else if (error > 5) color = 'yellow';
```

**åæ ‡è®¡ç®—**ï¼š
- ä½¿ç”¨èŠ‚ç‚¹ä¸­å¿ƒåæ ‡ï¼ˆè€Œéå·¦ä¸Šè§’ï¼‰
- è€ƒè™‘è§†å£å˜æ¢ï¼ˆzoom, panï¼‰
- æ ‡ç­¾ä½ç½®åœ¨è¿çº¿ä¸­ç‚¹

### ä½¿ç”¨åœºæ™¯

1. **å¸ƒå±€éªŒè¯**ï¼šæ£€æŸ¥è¿çº¿é•¿åº¦æ˜¯å¦ç»Ÿä¸€
2. **é—®é¢˜å®šä½**ï¼šå¿«é€Ÿæ‰¾åˆ°è¯¯å·®è¾ƒå¤§çš„è¿çº¿
3. **ç®—æ³•è°ƒä¼˜**ï¼šæ ¹æ®è¯¯å·®æ•°æ®è°ƒæ•´å¸ƒå±€å‚æ•°
4. **æ€§èƒ½åˆ†æ**ï¼šç»Ÿè®¡æ•´ä½“è¯¯å·®åˆ†å¸ƒ

### æ•°æ®ç»Ÿè®¡

æ§åˆ¶å°è¾“å‡ºå¸ƒå±€éªŒè¯ç»Ÿè®¡ï¼š

```javascript
[Layout] å¸ƒå±€éªŒè¯: {
  parallelSegments: [
    {
      segmentId: "parallel-segment-0",
      avgEdgeLength: "120.2",
      stdDeviation: "1.5",  // æ ‡å‡†å·®
      minEdgeLength: "118.5",
      maxEdgeLength: "122.1"
    }
  ],
  overall: {
    avgParallelEdgeLength: "120.1",
    avgSerialEdgeLength: "119.8"
  }
}
```

**ç›®æ ‡æŒ‡æ ‡**ï¼š
- æ ‡å‡†å·® < 3pxï¼ˆå½“å‰çº¦ 8-12pxï¼Œæ”¹è¿›åé¢„æœŸ < 3pxï¼‰
- å¹³å‡è¯¯å·® < 2px

---

## æ•°æ®å­˜å‚¨æ ¼å¼

### 1. å†…å­˜æ•°æ®ç»“æ„ï¼ˆZustand Storeï¼‰

```typescript
interface RecipeStore {
  // ä¸»æ•°æ®ç»“æ„
  processes: Process[];           // å·¥è‰ºæ®µåˆ—è¡¨
  edges: RecipeEdge[];           // å·¥è‰ºæ®µé—´è¿çº¿
  metadata: {
    name: string;
    version: string;
    updatedAt: string;
  };
  
  // UIçŠ¶æ€
  hoveredNodeId: string | null;
  selectedNodeId: string | null;
  expandedProcesses: Set<string>; // å±•å¼€çš„å·¥è‰ºæ®µIDé›†åˆ
  
  // å¸ƒå±€ç¼“å­˜
  nodePositions: Record<string, { x: number; y: number }>; // èŠ‚ç‚¹ä½ç½®ç¼“å­˜
  nodeHeights: Record<string, number>; // èŠ‚ç‚¹é«˜åº¦ç¼“å­˜ï¼ˆç”¨äºè°ƒè¯•ï¼‰
  nodeWidths: Record<string, number>; // èŠ‚ç‚¹å®½åº¦ç¼“å­˜ï¼ˆç”¨äºè°ƒè¯•ï¼‰
  
  // ç‰ˆæœ¬æ§åˆ¶
  version: number;               // ä¹è§‚é”ç‰ˆæœ¬å·
  isSaving: boolean;             // ä¿å­˜çŠ¶æ€
}
```

### 2. æ•°æ®åº“å­˜å‚¨æ ¼å¼ï¼ˆSQLiteï¼‰

#### è¡¨ç»“æ„

```sql
CREATE TABLE recipes (
  id TEXT PRIMARY KEY,              -- é…æ–¹IDï¼ˆé»˜è®¤ 'default'ï¼‰
  metadata TEXT NOT NULL,           -- JSONå­—ç¬¦ä¸²ï¼š{ name, version, updatedAt }
  processes TEXT NOT NULL,          -- JSONå­—ç¬¦ä¸²ï¼šProcess[] æ•°ç»„
  edges TEXT NOT NULL,              -- JSONå­—ç¬¦ä¸²ï¼šRecipeEdge[] æ•°ç»„
  version INTEGER DEFAULT 1,        -- ä¹è§‚é”ç‰ˆæœ¬å·
  updated_at TEXT NOT NULL,         -- ISO 8601 æ—¶é—´æˆ³
  updated_by TEXT                   -- æœ€åæ›´æ–°ç”¨æˆ·ID
);
```

#### JSON æ•°æ®æ ¼å¼

**Process ç»“æ„**ï¼š

```json
{
  "id": "P1",
  "name": "ç³–é†‡ã€ä¸‰æ°¯è”—ç³–ç±»æº¶è§£æ¶²",
  "description": "å¯é€‰æè¿°",
  "node": {
    "id": "P1",
    "type": "processNode",
    "label": "ç³–é†‡ã€ä¸‰æ°¯è”—ç³–ç±»æº¶è§£æ¶²",
    "subSteps": [
      {
        "id": "P1-substep-1",
        "order": 1,
        "processType": "dissolution",
        "label": "æº¶è§£",
        "deviceCode": "é«˜æ…æ¡¶1",
        "ingredients": "ç³–é†‡ã€ä¸‰æ°¯è”—ç³–",
        "params": {
          "processType": "dissolution",
          "dissolutionParams": {
            "waterVolumeMode": "ratio",
            "waterRatio": { "min": 5, "max": 8 },
            "waterTemp": { "min": 60, "max": 80, "unit": "â„ƒ" },
            "stirringTime": { "value": 30, "unit": "min" },
            "stirringRate": "high",
            "transferType": "material"
          }
        }
      }
    ]
  }
}
```

**RecipeEdge ç»“æ„**ï¼š

```json
{
  "id": "e_P1-P6",
  "source": "P1",
  "target": "P6",
  "type": "sequenceEdge",
  "data": {
    "sequenceOrder": 1
  },
  "animated": true
}
```

**å®Œæ•´ RecipeSchema**ï¼š

```json
{
  "metadata": {
    "name": "é¥®æ–™ç”Ÿäº§å·¥è‰ºé…æ–¹",
    "version": "1.0.0",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  },
  "processes": [
    { /* Process å¯¹è±¡ */ },
    { /* Process å¯¹è±¡ */ }
  ],
  "edges": [
    { /* RecipeEdge å¯¹è±¡ */ },
    { /* RecipeEdge å¯¹è±¡ */ }
  ]
}
```

### 3. èŠ‚ç‚¹ä½ç½®å’Œå°ºå¯¸å­˜å‚¨

**æ³¨æ„**ï¼šèŠ‚ç‚¹ä½ç½®ã€é«˜åº¦ã€å®½åº¦**ä¸å­˜å‚¨åœ¨æ•°æ®åº“ä¸­**ï¼Œä»…ä¿å­˜åœ¨å†…å­˜ä¸­çš„ç¼“å­˜ä¸­ã€‚æ¯æ¬¡åŠ è½½é…æ–¹æ—¶ï¼Œç”±å¸ƒå±€ç®—æ³•é‡æ–°è®¡ç®—ã€‚

```typescript
// å†…å­˜ä¸­çš„å¸ƒå±€ç¼“å­˜
nodePositions: {
  "P1": { x: 150, y: 80 },
  "P1-substep-1": { x: 150, y: 200 },
  "P2": { x: 514, y: 80 },
  // ...
}

nodeHeights: {
  "P1": 120,
  "P1-substep-1": 180,  // ç²¾ç¡®è®¡ç®—çš„é«˜åº¦
  "P2": 120,
  // ...
}

nodeWidths: {
  "P1": 200,
  "P1-substep-1": 200,
  "P2": 280,  // æ ¹æ®è¾“å…¥æ•°é‡åˆ†æ¡£
  // ...
}
```

**ç”¨é€”**ï¼š
- `nodePositions`ï¼šReact Flow æ¸²æŸ“èŠ‚ç‚¹ä½ç½®
- `nodeHeights`ï¼šè°ƒè¯•æ¨¡å¼è®¡ç®—è¿çº¿é•¿åº¦
- `nodeWidths`ï¼šè°ƒè¯•æ¨¡å¼è®¡ç®—èŠ‚ç‚¹ä¸­å¿ƒåæ ‡

---

## ä»£ç å®ç°ç»†èŠ‚

### 1. ä¸»å¸ƒå±€æ§åˆ¶å™¨ (`LayoutController.tsx`) âœ… å·²å®ç°

**å®ç°ä½ç½®**ï¼š`src/components/graph/LayoutController.tsx`

#### è§¦å‘æ¡ä»¶

å¸ƒå±€è®¡ç®—åœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘ï¼š

1. **èŠ‚ç‚¹åˆå§‹åŒ–å®Œæˆ**ï¼šä½¿ç”¨ `useNodesInitialized` ç­‰å¾… React Flow æµ‹é‡èŠ‚ç‚¹å°ºå¯¸
2. **å†…å®¹å˜åŒ–**ï¼šé€šè¿‡ `layoutTrigger` prop æ£€æµ‹å†…å®¹å˜åŒ–ï¼ˆå·¥è‰ºæ®µIDã€å­æ­¥éª¤IDã€å±•å¼€çŠ¶æ€ï¼‰
3. **é¦–æ¬¡å¸ƒå±€**ï¼šä½¿ç”¨ `hasLayoutedRef` ç¡®ä¿åªå¸ƒå±€ä¸€æ¬¡

#### å¸ƒå±€æµç¨‹

```typescript
export function LayoutController({ onLayoutComplete, onNodesUpdate, layoutTrigger }: LayoutControllerProps) {
  const { getNodes, setNodes, getEdges, fitView } = useReactFlow();
  const nodesInitialized = useNodesInitialized();
  const hasLayoutedRef = useRef(false);

  useLayoutEffect(() => {
    // 1. ç­‰å¾…èŠ‚ç‚¹åˆå§‹åŒ–ï¼ˆReact Flow å·²æµ‹é‡å°ºå¯¸ï¼‰
    if (!nodesInitialized) return;
    
    // 2. æ£€æŸ¥æ˜¯å¦å·²å¸ƒå±€è¿‡
    if (hasLayoutedRef.current) return;

    const nodes = getNodes() as FlowNode[];
    const edges = getEdges() as RecipeEdge[];

    // 3. æ”¶é›†çœŸå®å°ºå¯¸ï¼ˆReact Flow æµ‹é‡çš„ï¼‰
    const nodeHeights: Record<string, number> = {};
    const nodeWidths: Record<string, number> = {};
    nodes.forEach(node => {
      nodeHeights[node.id] = node.height || 120;
      nodeWidths[node.id] = node.width || 200;
    });

    // 4. è¯†åˆ«å·¥è‰ºæ®µ
    const { parallelSegments, serialSegments, convergenceNode } = 
      identifyProcessSegments(nodes, edges);

    // 5. åŸºäº displayOrder åˆ†é… X åæ ‡ï¼ˆå­˜å‚¨ä¸ºä¸­å¿ƒç‚¹ï¼‰
    const nodePositions: Record<string, { x: number; y: number }> = {};
    const nodesByDisplayOrder: Record<number, FlowNode[]> = {};
    // ... åˆ†ç»„å’Œåˆ†é… X åæ ‡é€»è¾‘

    // 6. å¸ƒå±€å¹¶è¡Œæ®µï¼ˆè®¡ç®— Y åæ ‡ï¼‰
    const parallelYPositions = layoutParallelSegments(
      parallelSegments,
      nodeHeights,
      { targetEdgeLength: 120, initialY: 80 }
    );

    // 7. è®¡ç®—æ±‡èšç‚¹ä½ç½® (X å’Œ Y)
    let convergenceY = 80;
    let convergenceX = 0;
    if (convergenceNode) {
      convergenceY = calculateConvergenceY(
        parallelSegments,
        parallelYPositions,
        nodeHeights,
        120,
        'max'
      );
      // è®¡ç®—æ±‡èšç‚¹ X åæ ‡ï¼ˆåŠ æƒè´¨å¿ƒæ³•ï¼‰
      // ...
    }

    // 8. å¸ƒå±€ä¸²è¡Œæ®µ
    const serialYPositions = layoutSerialSegments(
      serialSegments,
      convergenceY + (convergenceNode ? nodeHeights[convergenceNode.id] || 120 : 0),
      nodeHeights,
      { targetEdgeLength: 120 }
    );

    // 9. åº”ç”¨ X åæ ‡åˆ°ä¸²è¡Œæ®µï¼ˆä¸æ±‡èšç‚¹å¯¹é½ï¼‰
    if (convergenceX > 0) {
      serialSegments.forEach(segment => {
        segment.nodes.forEach(node => {
          if (nodePositions[node.id]) {
            nodePositions[node.id].x = convergenceX;
          }
        });
      });
    }

    // 10. åˆå¹¶ Y åæ ‡
    Object.keys(parallelYPositions).forEach(nodeId => {
      if (nodePositions[nodeId]) {
        nodePositions[nodeId].y = parallelYPositions[nodeId];
      }
    });
    Object.keys(serialYPositions).forEach(nodeId => {
      if (nodePositions[nodeId]) {
        nodePositions[nodeId].y = serialYPositions[nodeId];
      }
    });

    // 11. è½¬æ¢ä¸ºå·¦ä¸Šè§’åæ ‡ï¼ˆReact Flow ä½¿ç”¨å·¦ä¸Šè§’ï¼‰
    const layoutedNodes = nodes.map(node => {
      const pos = nodePositions[node.id];
      const width = nodeWidths[node.id] || 200;
      const height = nodeHeights[node.id] || 120;
      
      return {
        ...node,
        position: {
          x: pos.x - width / 2,  // ä¸­å¿ƒç‚¹ â†’ å·¦ä¸Šè§’
          y: pos.y - height / 2, // ä¸­å¿ƒç‚¹ â†’ å·¦ä¸Šè§’
        },
      };
    });

    // 12. æ›´æ–°èŠ‚ç‚¹ä½ç½®
    onNodesUpdate(layoutedNodes);
    setNodes(layoutedNodes);

    // 13. è°ƒç”¨ fitView å¹¶é€šçŸ¥å®Œæˆ
    window.requestAnimationFrame(() => {
      window.requestAnimationFrame(() => {
        fitView({ padding: 0.2, duration: 0 });
        hasLayoutedRef.current = true;
        onLayoutComplete();
      });
    });
  }, [nodesInitialized, getNodes, setNodes, getEdges, fitView, onLayoutComplete, onNodesUpdate]);

  return null; // Headless Component
}
```

#### åæ ‡ç³»ç»Ÿ

- **å†…éƒ¨è®¡ç®—**ï¼šä½¿ç”¨ä¸­å¿ƒç‚¹åæ ‡ï¼ˆ`{ x: centerX, y: centerY }`ï¼‰
- **æœ€ç»ˆè¾“å‡º**ï¼šè½¬æ¢ä¸ºå·¦ä¸Šè§’åæ ‡ï¼ˆReact Flow è¦æ±‚ï¼‰
- **è½¬æ¢å…¬å¼**ï¼š`å·¦ä¸Šè§’X = ä¸­å¿ƒX - å®½åº¦/2`ï¼Œ`å·¦ä¸Šè§’Y = ä¸­å¿ƒY - é«˜åº¦/2`

### 2. React Flow é›†æˆ

#### èŠ‚ç‚¹æ¸²æŸ“

èŠ‚ç‚¹ä½ç½®ä» `nodePositions` ç¼“å­˜ä¸­è¯»å–ï¼š

```typescript
export const useFlowNodes = (): FlowNode[] => {
  const nodePositions = useRecipeStore((state) => state.nodePositions);
  
  return useMemo(() => {
    const nodes: FlowNode[] = [];
    
    processes.forEach((process, index) => {
      const isExpanded = expandedProcesses.has(process.id);
      const displayOrder = index + 1;
      
      if (isExpanded) {
        // å±•å¼€æ¨¡å¼ï¼šä¸ºæ¯ä¸ªå­æ­¥éª¤åˆ›å»ºèŠ‚ç‚¹
        process.node.subSteps.forEach((subStep) => {
          nodes.push({
            id: subStep.id,
            type: 'subStepNode',
            position: nodePositions[subStep.id] || { x: 0, y: 0 },
            data: { subStep, processId: process.id, displayOrder }
          });
        });
      } else {
        // æŠ˜å æ¨¡å¼ï¼šåˆ›å»ºæ±‡æ€»èŠ‚ç‚¹
        nodes.push({
          id: process.id,
          type: 'processSummaryNode',
          position: nodePositions[process.id] || { x: 0, y: 0 },
          data: {
            processId: process.id,
            processName: process.name,
            subStepCount: process.node.subSteps.length,
            displayOrder
          }
        });
      }
    });
    
    return nodes;
  }, [processes, expandedProcesses, nodePositions]);
};
```

#### è¾¹æ¸²æŸ“

è¾¹çš„ `targetHandle` å’Œ `sourceHandle` æ ¹æ®è¾“å…¥/è¾“å‡ºæ•°é‡åŠ¨æ€åˆ†é…ï¼š

```typescript
export const useFlowEdges = (): RecipeEdge[] => {
  return useMemo(() => {
    const flowEdges: RecipeEdge[] = [];
    
    // 1. å¤„ç†å·¥è‰ºæ®µé—´è¿çº¿
    edges.forEach(edge => {
      // æ ¹æ®å±•å¼€çŠ¶æ€ç¡®å®šå®é™…çš„ source/target èŠ‚ç‚¹ID
      const sourceNodeId = sourceExpanded 
        ? sourceProcess.node.subSteps[sourceProcess.node.subSteps.length - 1].id
        : sourceProcess.id;
      const targetNodeId = targetExpanded
        ? targetProcess.node.subSteps[0].id
        : targetProcess.id;
      
      flowEdges.push({ ...edge, source: sourceNodeId, target: targetNodeId });
    });
    
    // 2. å¤„ç†å·¥è‰ºæ®µå†…éƒ¨è¿çº¿ï¼ˆå±•å¼€æ—¶ï¼‰
    processes.forEach(process => {
      if (expandedProcesses.has(process.id) && process.node.subSteps.length > 1) {
        for (let idx = 0; idx < process.node.subSteps.length - 1; idx++) {
          flowEdges.push({
            id: `internal-${current.id}-${next.id}`,
            source: current.id,
            target: next.id,
            type: 'sequenceEdge',
            data: { sequenceOrder: 1 }
          });
        }
      }
    });
    
    // 3. åˆ†é… targetHandle å’Œ sourceHandle
    return flowEdges.map(edge => {
      const incomingEdges = nodeIncomingEdges.get(edge.target) || [];
      let targetHandle: string | undefined;
      
      if (incomingEdges.length > 1) {
        const sortedInEdges = [...incomingEdges].sort((a, b) => 
          (a.data?.sequenceOrder || 0) - (b.data?.sequenceOrder || 0)
        );
        const handleIndex = sortedInEdges.findIndex(e => e.id === edge.id);
        if (handleIndex >= 0) targetHandle = `target-${handleIndex}`;
      }
      
      // sourceHandle ç±»ä¼¼é€»è¾‘...
      
      return { ...edge, targetHandle, sourceHandle };
    });
  }, [processes, edges, expandedProcesses, nodePositions]);
};
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜æœºåˆ¶

- **ç­¾åæ¯”è¾ƒ**ï¼šä½¿ç”¨ JSON ç­¾åæ¯”è¾ƒï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°è®¡ç®—
- **ä½ç½®ç¼“å­˜**ï¼šèŠ‚ç‚¹ä½ç½®ç¼“å­˜åœ¨ Store ä¸­ï¼Œé¿å…é‡å¤è®¡ç®—

### 2. è®¡ç®—ä¼˜åŒ–

- **æŒ‰éœ€è®¡ç®—**ï¼šåªåœ¨æ•°æ®å˜åŒ–æ—¶è§¦å‘å¸ƒå±€è®¡ç®—
- **æ‰¹é‡æ›´æ–°**ï¼šæ‰€æœ‰ä½ç½®è®¡ç®—å®Œæˆåï¼Œä¸€æ¬¡æ€§æ›´æ–° Store

### 3. React ä¼˜åŒ–

- **useMemo**ï¼š`useFlowNodes` å’Œ `useFlowEdges` ä½¿ç”¨ `useMemo` ç¼“å­˜ç»“æœ
- **memo**ï¼š`CustomNode` å’Œ `SequenceEdge` ä½¿ç”¨ `React.memo` é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“

### 4. å¸ƒå±€ç®—æ³•ä¼˜åŒ–

- **çœŸå®å°ºå¯¸æµ‹é‡**ï¼šä½¿ç”¨ React Flow è‡ªåŠ¨æµ‹é‡çš„èŠ‚ç‚¹å°ºå¯¸ï¼Œæ— éœ€ä¼°ç®—
- **åæ ‡ç³»ç»Ÿä¼˜åŒ–**ï¼šå†…éƒ¨ä½¿ç”¨ä¸­å¿ƒç‚¹åæ ‡è®¡ç®—ï¼Œæœ€åè½¬æ¢ä¸ºå·¦ä¸Šè§’åæ ‡
- **å¸ƒå±€è§¦å‘ä¼˜åŒ–**ï¼šåŸºäºå†…å®¹å˜åŒ–è§¦å‘å™¨ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°è®¡ç®—

**æ³¨æ„**ï¼šæ–‡æ¡£ä¸­æè¿°çš„"æ™ºèƒ½ç»Ÿä¸€å°ºå¯¸"å’Œ"å¹¶è¡Œåˆ†æ”¯å‹ç¼©"åŠŸèƒ½æœªå®ç°ã€‚

---

## æ€»ç»“

æœ¬è‡ªåŠ¨å¸ƒå±€ç®—æ³•é‡‡ç”¨**å·¥è‰ºæ®µè¯†åˆ« + åˆ†æ®µå¸ƒå±€**çš„ç­–ç•¥ï¼Œèƒ½å¤Ÿï¼š

1. âœ… è‡ªåŠ¨è¯†åˆ«å¹¶è¡Œå’Œä¸²è¡Œå·¥è‰ºæ®µ
2. âœ… ç¡®ä¿è¿çº¿é•¿åº¦ç»Ÿä¸€ï¼ˆ120pxï¼‰
3. âœ… ä½¿ç”¨ React Flow è‡ªåŠ¨æµ‹é‡çš„çœŸå®èŠ‚ç‚¹å°ºå¯¸
4. âœ… åŸºäºè¡¨æ ¼é¡ºåºï¼ˆ`displayOrder`ï¼‰è¿›è¡Œæ°´å¹³å¯¹é½
5. âœ… æ™ºèƒ½å¤„ç†æ±‡èšç‚¹çš„å±…ä¸­ï¼ˆåŠ æƒè´¨å¿ƒç®—æ³•ï¼‰
6. âœ… æä¾›è°ƒè¯•æ¨¡å¼å¯è§†åŒ–å¸ƒå±€é—®é¢˜

ç®—æ³•å…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œæ€§èƒ½ï¼Œèƒ½å¤Ÿå¤„ç†å¤æ‚çš„å·¥è‰ºæµç¨‹å›¾å½¢å¸ƒå±€éœ€æ±‚ã€‚

### æœªæ¥æ”¹è¿›æ–¹å‘

ä»¥ä¸‹åŠŸèƒ½åœ¨æ–‡æ¡£ä¸­æè¿°ä½†æœªå®ç°ï¼Œå¯ä½œä¸ºæœªæ¥æ”¹è¿›æ–¹å‘ï¼š

1. **æ™ºèƒ½ç»Ÿä¸€å°ºå¯¸**ï¼šå¯¹ç›¸åŒå·¥è‰ºç±»å‹çš„èŠ‚ç‚¹è¿›è¡Œèšç±»ï¼Œç»Ÿä¸€å°ºå¯¸
2. **åˆ†æ”¯é‡æ’åº**ï¼šæ ¹æ® `sequenceOrder` å’Œ `Process Index` é‡æ’åºåˆ†æ”¯
3. **å¹¶è¡Œåˆ†æ”¯å‹ç¼©**ï¼šå‹ç¼©æ— ç›´æ¥è¿æ¥çš„å¹¶è¡ŒèŠ‚ç‚¹é—´è·ï¼ŒèŠ‚çœç©ºé—´

---

## ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒå¸ƒå±€æ–‡ä»¶

- `src/components/graph/LayoutController.tsx` - ä¸»å¸ƒå±€æ§åˆ¶å™¨ï¼ˆHeadless Componentï¼‰
- `src/components/graph/RecipeFlow.tsx` - React Flow ç»„ä»¶ï¼ˆé›†æˆå¸ƒå±€æ§åˆ¶å™¨ï¼‰
- `src/hooks/segmentIdentifier.ts` - å·¥è‰ºæ®µè¯†åˆ«ç®—æ³•
- `src/hooks/segmentLayoutCalculator.ts` - åˆ†æ®µå¸ƒå±€è®¡ç®—å™¨

### è°ƒè¯•ç»„ä»¶

- `src/components/graph/DebugOverlay.tsx` - è°ƒè¯•å åŠ å±‚ç»„ä»¶ï¼ˆæ˜¾ç¤ºè¿çº¿é•¿åº¦ï¼‰
- `src/components/graph/DebugStatsPanel.tsx` - è°ƒè¯•ç»Ÿè®¡é¢æ¿ï¼ˆæ˜¾ç¤ºå¸ƒå±€ç»Ÿè®¡ï¼‰

### èŠ‚ç‚¹ç»„ä»¶

- `src/components/graph/CustomNode.tsx` - è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶ï¼ˆåŒ…å«åˆ†æ¡£å®½åº¦è®¡ç®—ï¼‰

### çŠ¶æ€ç®¡ç†

- `src/store/useRecipeStore.ts` - çŠ¶æ€ç®¡ç†ï¼ˆåŒ…å«èŠ‚ç‚¹ä½ç½®ç¼“å­˜ï¼‰

### ç±»å‹å®šä¹‰

- `src/types/recipe.ts` - ç±»å‹å®šä¹‰ï¼ˆFlowNode, RecipeEdge, ProcessSegment ç­‰ï¼‰

### æ•°æ®åº“

- `server/src/db.ts` - æ•°æ®åº“æ“ä½œ

---

## å®ç°çŠ¶æ€è¯´æ˜

### å·²å®ç°åŠŸèƒ½ âœ…

1. **å·¥è‰ºæ®µè¯†åˆ«**ï¼šå®Œæ•´å®ç°ï¼Œä½¿ç”¨ DFS ç®—æ³•è¯†åˆ«å¹¶è¡Œå’Œä¸²è¡Œå·¥è‰ºæ®µ
2. **å¹¶è¡Œæ®µå¸ƒå±€**ï¼šå®Œæ•´å®ç°ï¼Œå›ºå®šè¿çº¿é•¿åº¦ 120px
3. **ä¸²è¡Œæ®µå¸ƒå±€**ï¼šå®Œæ•´å®ç°ï¼Œä»æ±‡èšç‚¹å‘ä¸‹æ’åˆ—
4. **æ±‡èšç‚¹è®¡ç®—**ï¼šå®Œæ•´å®ç°ï¼Œæ”¯æŒ Y åæ ‡ï¼ˆmax/weighted/median ç­–ç•¥ï¼‰å’Œ X åæ ‡ï¼ˆåŠ æƒè´¨å¿ƒï¼‰
5. **æ°´å¹³å¸ƒå±€**ï¼šå®Œæ•´å®ç°ï¼ŒåŸºäº `displayOrder` åˆ†é…æ°´å¹³è½¦é“
6. **åˆ†æ¡£å®½åº¦**ï¼šå®Œæ•´å®ç°ï¼Œåœ¨ `CustomNode.tsx` ä¸­æ ¹æ®è¾“å…¥æ•°é‡è®¡ç®—
7. **èŠ‚ç‚¹å°ºå¯¸è·å–**ï¼šå®Œæ•´å®ç°ï¼Œä½¿ç”¨ React Flow è‡ªåŠ¨æµ‹é‡
8. **è°ƒè¯•æ¨¡å¼**ï¼šå®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬å¯è§†åŒ–å åŠ å±‚å’Œç»Ÿè®¡é¢æ¿

### æœªå®ç°åŠŸèƒ½ âŒ

ä»¥ä¸‹åŠŸèƒ½åœ¨æ–‡æ¡£ä¸­æè¿°ï¼Œä½†åœ¨ä»£ç ä¸­**ä¸å­˜åœ¨**ï¼š

1. **Canvas API æ–‡å­—æµ‹é‡**ï¼š
   - `wrapText` å‡½æ•°
   - `measureTextHeight` å‡½æ•°
   - åŸºäº Canvas çš„é«˜åº¦ä¼°ç®—é€»è¾‘
   - **åŸå› **ï¼šä½¿ç”¨ React Flow è‡ªåŠ¨æµ‹é‡ï¼Œæ— éœ€æ‰‹åŠ¨è®¡ç®—

2. **æ™ºèƒ½ç»Ÿä¸€å°ºå¯¸**ï¼š
   - `calculateIntelligentUnifiedSizes` å‡½æ•°
   - æŒ‰å·¥è‰ºç±»å‹èšç±»ç»Ÿä¸€å°ºå¯¸
   - **åŸå› **ï¼šå½“å‰æ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç‹¬ç«‹è®¡ç®—çš„å°ºå¯¸

3. **åˆ†æ”¯é‡æ’åº**ï¼š
   - `reorderBranchesHorizontally` å‡½æ•°
   - æ ¹æ® `sequenceOrder` å’Œ `Process Index` é‡æ’åº
   - **åŸå› **ï¼šåŠŸèƒ½æœªå®ç°

4. **å¹¶è¡Œåˆ†æ”¯å‹ç¼©**ï¼š
   - `compressParallelBranches` å‡½æ•°
   - å‹ç¼©æ— ç›´æ¥è¿æ¥çš„å¹¶è¡ŒèŠ‚ç‚¹é—´è·
   - **åŸå› **ï¼šåŠŸèƒ½æœªå®ç°

### å®ç°å·®å¼‚è¯´æ˜

1. **å¸ƒå±€å…¥å£**ï¼š
   - **æ–‡æ¡£æè¿°**ï¼š`useAutoLayout.ts` hook
   - **å®é™…å®ç°**ï¼š`LayoutController.tsx` Headless Component
   - **åŸå› **ï¼šéœ€è¦åœ¨ React Flow å†…éƒ¨ä½¿ç”¨ `useReactFlow` å’Œ `useNodesInitialized`

2. **èŠ‚ç‚¹å°ºå¯¸è®¡ç®—**ï¼š
   - **æ–‡æ¡£æè¿°**ï¼šCanvas API ç²¾ç¡®æµ‹é‡æ–‡å­—é«˜åº¦
   - **å®é™…å®ç°**ï¼šReact Flow è‡ªåŠ¨æµ‹é‡çš„çœŸå®å°ºå¯¸
   - **åŸå› **ï¼šReact Flow 11 æä¾›äº†è‡ªåŠ¨å°ºå¯¸æµ‹é‡ï¼Œæ›´å‡†ç¡®ä¸”æ— éœ€ç»´æŠ¤

3. **åæ ‡ç³»ç»Ÿ**ï¼š
   - **å†…éƒ¨è®¡ç®—**ï¼šä½¿ç”¨ä¸­å¿ƒç‚¹åæ ‡
   - **æœ€ç»ˆè¾“å‡º**ï¼šè½¬æ¢ä¸ºå·¦ä¸Šè§’åæ ‡ï¼ˆReact Flow è¦æ±‚ï¼‰
   - **æ–‡æ¡£è¯´æ˜**ï¼šå·²æ›´æ–°ä»¥åæ˜ å®é™…å®ç°

---

## æ›´æ–°æ—¥å¿—

### 2024-XX-XXï¼šæ–‡æ¡£æ›´æ–°

**æ›´æ–°å†…å®¹**ï¼š
- âœ… æ›´æ–°æ–‡æ¡£ä»¥åæ˜ å®é™…å®ç°
- âœ… æ ‡æ³¨å·²å®ç°å’Œæœªå®ç°çš„åŠŸèƒ½
- âœ… ä¿®æ­£æ–‡ä»¶è·¯å¾„å’Œä»£ç ç¤ºä¾‹
- âœ… æ›´æ–°åæ ‡ç³»ç»Ÿè¯´æ˜
- âœ… æ·»åŠ å®ç°çŠ¶æ€æ€»è§ˆè¡¨

**ä¸»è¦å˜æ›´**ï¼š
- å¸ƒå±€å…¥å£ä» `useAutoLayout.ts` æ›´æ­£ä¸º `LayoutController.tsx`
- èŠ‚ç‚¹å°ºå¯¸è®¡ç®—ä» Canvas API æ›´æ­£ä¸º React Flow è‡ªåŠ¨æµ‹é‡
- æ ‡æ³¨æœªå®ç°åŠŸèƒ½ï¼ˆCanvas APIã€æ™ºèƒ½ç»Ÿä¸€å°ºå¯¸ã€åˆ†æ”¯é‡æ’åºã€å¹¶è¡Œåˆ†æ”¯å‹ç¼©ï¼‰

